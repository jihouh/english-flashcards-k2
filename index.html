<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Small Steps Spelling</title>
    <link href="https://fonts.googleapis.com/css2?family=Comic+Neue:wght@400;700&family=Klee+One:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        :root {
            --primary: #FF6B6B; --secondary: #4ECDC4; --accent: #FFE66D;
            --blue: #45aaf2; --bg: #F7FFF7; --gray: #555;
            --light-gray: #e0e0e0; --delete: #ff9f43;
            --purple: #a55eea; --shadow: #d4e5d4;
            --challenge: #eb4d4b; --success: #2ecc71;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background-color: var(--bg);
            margin: 0; padding: 0;
            display: flex; flex-direction: column;
            height: 100vh; overflow: hidden;
            -webkit-user-select: none; user-select: none;
        }

        .header { width: 100%; display: flex; justify-content: space-between; align-items: center; padding: 15px; background: var(--bg); }
        h1 { font-size: clamp(18px, 4vw, 28px); color: var(--primary); margin: 0; font-family: 'Klee One', cursive; font-weight: 600; }
        
        .header-controls { display: flex; gap: 10px; }
        .fullscreen-btn, .admin-toggle-btn { background: #eee; color: #666; font-size: 12px; padding: 8px 12px; border-radius: 10px; border: 1px solid #ddd; cursor: pointer; font-weight: bold; }

        .nav-bar {
            position: fixed; bottom: 0; width: 100%; background: white; 
            display: flex; justify-content: space-around; padding: 15px 0;
            box-shadow: 0 -4px 15px rgba(0,0,0,0.1); z-index: 100;
        }
        .nav-item { font-family: 'Klee One', cursive; font-weight: bold; color: #888; cursor: pointer; font-size: 14px; text-align: center; flex: 1; }
        .nav-item i { display: block; font-size: 24px; margin-bottom: 4px; font-style: normal; }
        .nav-item.active { color: var(--primary); }

        .container { flex: 1; display: flex; flex-direction: column; align-items: center; padding: 10px 20px 100px 20px; overflow-y: auto; }
        .screen { display: none; width: 100%; max-width: 800px; animation: fadeIn 0.3s; }
        .active-screen { display: flex; flex-direction: column; align-items: center; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Challenge UI */
        .challenge-hud { width: 100%; display: flex; justify-content: space-between; align-items: center; padding: 12px 20px; background: white; border-radius: 20px; border: 3px solid var(--challenge); margin-bottom: 15px; }
        .hud-item { flex: 1; text-align: center; font-family: 'Klee One'; font-weight: bold; border-right: 1px solid #eee; }
        .hud-item:last-child { border-right: none; }
        .hud-label { font-size: 10px; color: #888; text-transform: uppercase; display: block; }
        .hud-val { font-size: 20px; color: var(--challenge); display: block; }
        
        #ch-results { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); z-index: 500; flex-direction: column; align-items: center; padding: 40px 20px; overflow-y: auto; }
        .summary-card { background: white; border-radius: 30px; padding: 25px; width: 100%; max-width: 500px; border: 4px solid var(--blue); box-shadow: 0 10px 0 var(--shadow); }
        .stat-line { display: flex; justify-content: space-between; font-size: 20px; margin: 10px 0; font-family: 'Klee One'; }
        .practice-tag { display: inline-block; background: #fff0f0; color: var(--primary); padding: 5px 12px; border-radius: 15px; margin: 4px; font-weight: bold; border: 1px solid #ffdada; }

        .instruction-text { font-family: 'Klee One', cursive; color: var(--gray); font-size: 22px; margin-bottom: 10px; text-align: center; }
        .card-img { width: 100%; max-width: 320px; height: auto; max-height: 22vh; object-fit: contain; border-radius: 25px; background: white; padding: 10px; border: 5px solid var(--secondary); display: block; margin: 0 auto; }
        
        .spell-row { display: flex; justify-content: center; gap: 6px; margin: 15px 0; width: 100%; flex-wrap: wrap; }
        .slot { min-width: 32px; width: clamp(32px, 7vw, 50px); height: 45px; border-bottom: 4px solid var(--secondary); font-size: 1.8rem; color: var(--primary); text-align: center; font-family: 'Comic Neue'; font-weight: bold; }
        .slot.prefilled { color: #aaa; border-bottom-color: #eee; }
        .letter-btn { width: 55px; height: 55px; background: var(--blue); border: none; border-radius: 12px; box-shadow: 0 4px 0px #348ecc; font-size: 1.6rem; color: white; font-family: 'Comic Neue'; cursor: pointer; }
        .match-btn { width: 100%; max-width: 350px; background: white; font-size: 22px; padding: 12px; border-radius: 18px; border: 3px solid var(--accent); box-shadow: 0 5px 0px var(--accent); margin-bottom: 10px; font-family: 'Comic Neue'; font-weight: 800; cursor: pointer; text-align: center; }
        
        .quote-card { background: white; padding: 15px; border-radius: 20px; border: 2px dashed var(--secondary); margin: 15px 0; width: 100%; text-align: center; cursor: pointer; box-shadow: 0 4px 0 var(--shadow); }
        #motivational-quote { font-family: 'Klee One', cursive; color: #555; font-size: 18px; margin: 0; }
        .home-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; width: 100%; }
        button.action-btn { padding: 10px; border-radius: 20px; border: none; color: white; font-weight: 900; cursor: pointer; font-family: 'Klee One', cursive; font-size: 16px; height: 80px; display: flex; align-items: center; justify-content: center; gap: 10px; }

        .admin-box { background: white; padding: 15px; border-radius: 20px; border: 3px solid #ddd; width: 100%; margin-bottom: 15px; }
        .admin-input { width: 100%; padding: 10px; margin: 8px 0; border: 2px solid #eee; border-radius: 10px; }
        .full-width-slider { width: 100%; margin: 10px 0; }
        .switch-container { display: flex; align-items: center; justify-content: space-between; margin: 10px 0; }
        .switch { position: relative; display: inline-block; width: 44px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--secondary); }
        input:checked + .slider:before { transform: translateX(20px); }

        .admin-controls-btn { border: none; background: #f0f0f0; border-radius: 5px; cursor: pointer; padding: 5px; margin-left: 5px; font-size: 14px; }

        .lib-grid { display: flex; flex-direction: column; gap: 10px; width: 100%; }
        .lib-card { background: white; border: 3px solid var(--light-gray); padding: 12px 20px; display: flex; align-items: center; justify-content: space-between; border-radius: 25px; cursor: pointer; }
        .lib-word { font-size: 24px; font-family: 'Comic Neue'; font-weight: bold; color: var(--gray); text-transform: lowercase; }
        #lib-popup { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; justify-content: center; align-items: center; }
    </style>
</head>
<body>

    <div id="ch-results">
        <h1 style="color:var(--blue); font-size: 40px;">Time's Up! üèÅ</h1>
        <div class="summary-card">
            <div class="stat-line"><span>Final Score:</span><strong id="res-score" style="color:var(--challenge)">0</strong></div>
            <hr style="border: 0; border-top: 1px solid #eee;">
            <div class="stat-line"><span>‚úÖ Correct Words:</span><strong id="res-correct" style="color:var(--success)">0</strong></div>
            <div class="stat-line"><span>‚ùå Mistakes Made:</span><strong id="res-wrong" style="color:var(--primary)">0</strong></div>
            <div id="res-practice-list" style="margin-bottom: 20px;"></div>
            <button class="action-btn" style="background:var(--secondary); width:100%; height:60px;" onclick="closeResults()">BACK TO HOME</button>
        </div>
    </div>

    <div id="lib-popup">
        <div class="popup-content" style="background: white; padding: 30px; border-radius: 35px; text-align: center; position: relative; width: 85%;">
            <button style="position:absolute; top:-10px; right:-10px; background:var(--primary); color:white; border:none; width:40px; height:40px; border-radius:50%; font-weight:bold;" onclick="closePopup()">X</button>
            <img id="popup-img" style="width: 200px; height: 200px; object-fit: contain;">
            <h2 id="popup-text" style="font-family: 'Comic Neue'; color: var(--primary); font-size: 32px; text-transform: lowercase;">word</h2>
            <button id="replay-voice" style="background:var(--secondary); color:white; border:none; padding:15px 30px; border-radius:50px; font-size:24px; font-family:'Comic Neue';">üîä REPLAY</button>
        </div>
    </div>

    <div class="header">
        <h1>Small Steps Spelling ‚ú®</h1>
        <div class="header-controls">
            <button class="admin-toggle-btn" onclick="checkAdminAccess()">‚öôÔ∏è PARENT</button>
            <button class="fullscreen-btn" onclick="toggleFullscreen()">üñ•Ô∏è</button>
        </div>
    </div>

    <div class="container">
        <div id="home" class="screen active-screen">
            <h2 id="home-greeting" style="font-family: 'Klee One'; text-align: center; color: var(--primary); font-size: 32px; margin: 0;">Hi Student! üëã</h2>
            <div class="quote-card" onclick="readQuoteOutLoud()">
                <p id="motivational-quote">"Mistakes are proof that you are trying!" üåü</p>
                <div style="font-size: 10px; color: #aaa; margin-top: 5px;">(Tap to listen)</div>
            </div>
            <div id="stars-total" style="font-family: 'Klee One'; color: var(--blue); font-size: 20px; text-align: center;">üåü 0 Mastery Stars</div>
            <div class="home-grid" style="margin-top: 20px;">
                <button class="action-btn" style="background: var(--secondary);" onclick="showScreen('learn')">üìñ LEARN</button>
                <button class="action-btn" style="background: var(--blue);" onclick="showScreen('spell')">‚úèÔ∏è SPELL</button>
                <button class="action-btn" style="background: var(--purple);" onclick="showScreen('match')">üß© MATCH</button>
                <button class="action-btn" style="background: var(--challenge);" onclick="showScreen('challenge')">üî• CHALLENGE</button>
                <button class="action-btn" style="background: var(--primary); grid-column: span 2;" onclick="showScreen('library')">üìö LIBRARY</button>
            </div>
        </div>

        <div id="challenge" class="screen">
            <div class="challenge-hud">
                <div class="hud-item"><span class="hud-label">Best</span><span id="ch-high" class="hud-val">0</span></div>
                <div class="hud-item"><span class="hud-label">Time</span><span id="ch-timer" class="hud-val">0:30</span></div>
                <div class="hud-item"><span class="hud-label">Score</span><span id="ch-score" class="hud-val">0</span></div>
            </div>
            <div id="challenge-task-area" style="width:100%; text-align: center;">
                <div class="instruction-text" id="ch-instruction">Get ready!</div>
                <img id="ch-img" class="card-img" src="">
                <div id="ch-content" style="display: flex; flex-direction: column; align-items: center; justify-content: center; width: 100%; margin-top: 15px;"></div>
            </div>
            <button class="action-btn" style="background:var(--gray); width:100%; height:60px; margin-top:30px;" onclick="quitChallenge()">QUIT CHALLENGE</button>
        </div>

        <div id="admin" class="screen">
            <h2 style="font-family: 'Klee One';">Parent Tools ‚öôÔ∏è</h2>
            <div class="admin-box">
                <h4 style="margin:0; color:var(--gray)">Student Name</h4>
                <input type="text" id="name-input" class="admin-input" placeholder="Enter Name">
                <button class="action-btn" style="background:var(--secondary); height:40px; width:100%; font-size:14px;" onclick="updateName()">SAVE NAME</button>
            </div>
            <div class="admin-box">
                <h4 style="margin:0; color:var(--challenge)">Challenge Timer</h4>
                <p style="font-size:12px; color:#777; margin:5px 0;">Duration: <span id="ch-timer-val" style="font-weight:bold; color:var(--blue)">30s</span></p>
                <input type="range" id="ch-timer-slider" class="full-width-slider" min="30" max="180" step="15" value="30" oninput="updateChTimer(this.value)">
            </div>
            <div class="admin-box">
                <div class="switch-container">
                    <h4 style="margin:0; color:var(--purple)">Randomise Learning Order</h4>
                    <label class="switch"><input type="checkbox" id="random-toggle" onchange="toggleRandom(this.checked)"><span class="slider"></span></label>
                </div>
            </div>
            <div class="admin-box">
                <h4 style="margin:0; color:var(--primary)">Spelling Difficulty</h4>
                <p id="diff-desc" style="font-size:12px; color:#777; margin:5px 0;">Difficulty: 50% Hidden</p>
                <input type="range" id="diff-slider" class="full-width-slider" min="0" max="100" step="25" value="50" oninput="updateDiff(this.value)">
            </div>
            <div class="admin-box">
                <h4 style="margin:0 0 5px 0; color:var(--blue)">Add New Word</h4>
                <input type="text" id="new-word-text" class="admin-input" placeholder="Word">
                <input type="text" id="new-word-img" class="admin-input" placeholder="Image URL">
                <button class="action-btn" style="background:var(--blue); height:40px; width:100%; font-size:14px;" onclick="addNewWord()">ADD WORD</button>
            </div>
            <div class="admin-box">
                <h4 style="margin:0 0 10px 0; color:var(--gray)">Word Management</h4>
                <div style="max-height: 250px; overflow-y: auto;"><table style="width:100%; border-collapse: collapse;" id="admin-word-list"></table></div>
            </div>
            <div class="admin-box" style="border-color: #ff9f43;">
                <h4 style="margin:0; color:#ff9f43">Progress & Data</h4>
                <button class="action-btn" style="background:#ff9f43; height:45px; width:100%; font-size:14px;" onclick="resetProgress()">RESET ALL PROGRESS & RELOAD</button>
            </div>
            <button class="action-btn" style="background:var(--gray); height:60px; width:100%; margin-top: 10px;" onclick="showScreen('home')">LOGOUT</button>
        </div>

        <div id="learn" class="screen">
            <div class="instruction-text">Tap word to hear spelling!</div>
            <img id="learn-img" class="card-img" src="">
            <div id="learn-word" style="font-size: 3rem; color: var(--primary); font-family: 'Comic Neue'; font-weight: bold; margin: 20px 0; cursor: pointer; text-transform: lowercase;" onclick="handleLearnClick()">word</div>
            <div style="display:flex; gap:15px; width: 100%;">
                <button class="action-btn" style="background:var(--accent); color:black; flex:1;" onclick="prevItem('learn')">‚¨ÖÔ∏è BACK</button>
                <button class="action-btn" style="background:var(--secondary); flex:1;" onclick="nextItem('learn')">NEXT ‚û°Ô∏è</button>
            </div>
        </div>

        <div id="spell" class="screen">
            <div class="instruction-text">Spell the word!</div>
            <img id="spell-img" class="card-img" src="">
            <div id="spell-container" class="spell-row"></div>
            <div id="letter-pool" style="display:flex; flex-wrap:wrap; justify-content:center; gap:8px;"></div>
            <div style="display:flex; gap:15px; margin-top: 25px; width: 100%;">
                <button class="action-btn" style="background:var(--accent); color:black; flex:1;" onclick="prevItem('spell')">‚¨ÖÔ∏è BACK</button>
                <button class="action-btn" style="background:var(--delete); flex:1;" onclick="handleBackspace()">‚å´ DELETE</button>
            </div>
        </div>

        <div id="match" class="screen">
            <div class="instruction-text">Find the match!</div>
            <img id="match-img" class="card-img" src="">
            <div id="match-options" style="width:100%; margin-top:20px; display:flex; flex-direction:column; align-items:center;"></div>
            <div style="display:flex; gap:15px; margin-top: 25px; width: 100%;">
                <button class="action-btn" style="background:var(--accent); color:black; flex:1;" onclick="prevItem('match')">‚¨ÖÔ∏è BACK</button>
                <button class="action-btn" style="background:var(--secondary); flex:1;" onclick="showScreen('home')">HOME üè†</button>
            </div>
        </div>

        <div id="library" class="screen">
            <div class="instruction-text" style="font-size:14px">üëâ Tap to Read | üëÜ Hold for Image</div>
            <div class="lib-grid" id="library-grid"></div>
        </div>
    </div>

    <div class="nav-bar">
        <div class="nav-item active" id="nav-home" onclick="showScreen('home')"><i>üè†</i>Home</div>
        <div class="nav-item" id="nav-learn" onclick="showScreen('learn')"><i>üìñ</i>Learn</div>
        <div class="nav-item" id="nav-spell" onclick="showScreen('spell')"><i>‚úèÔ∏è</i>Spell</div>
        <div class="nav-item" id="nav-match" onclick="showScreen('match')"><i>üß©</i>Match</div>
        <div class="nav-item" id="nav-challenge" onclick="showScreen('challenge')"><i>üî•</i>Chall.</div>
        <div class="nav-item" id="nav-lib" onclick="showScreen('library')"><i>üìö</i>Lib</div>
    </div>

<script>
    const DEFAULT_ADMIN_PASS = "1234";
    let defaultWords = [
        { word: 'toys', img: 'https://img.freepik.com/premium-vector/vector-illustration-kids-toys_29937-1394.jpg', count: 0, active: true },
        { word: 'games', img: 'https://img.freepik.com/free-vector/set-children-board-game_1308-132958.jpg?semt=ais_user_personalization&w=740&q=200', count: 0, active: true },
        { word: 'sports', img: 'https://img.freepik.com/premium-vector/four-diverse-children-playing-different-sports_657438-40419.jpg', count: 0, active: true },
        { word: 'healthy', img: 'https://img.freepik.com/premium-photo/encouraging-healthy-eating-lifestyle-habits-children_1104763-20631.jpg?w=360', count: 0, active: true },
        { word: 'exercise', img: 'https://img.freepik.com/premium-vector/yoga-kids-characters-fitness-sport-children-pose-gymnastics-yoga-exercises-vector-illustrations_723224-5258.jpg', count: 0, active: true },
        { word: 'doll', img: 'https://img.freepik.com/premium-vector/girl-with-pink-dress-pink-dress_1399003-411.jpg', count: 0, active: true },
        { word: 'blocks', img: 'https://img.freepik.com/free-psd/colorful-wooden-blocks-stacked-high-fun-playful-building_191095-90533.jpg', count: 0, active: true },
        { word: 'marble', img: 'https://img.freepik.com/premium-photo/group-twelve-clear-glass-marbles-with-colorful-swirls-inside-placed-white-surface_1187944-4229.jpg', count: 0, active: true },
        { word: 'puzzle', img: 'https://img.freepik.com/premium-vector/cheerful-young-children-enjoying-jigsaw-puzzle-activity-together_1313002-9866.jpg', count: 0, active: true },
        { word: 'balloon', img: 'https://img.freepik.com/free-psd/bunch-floating-balloons-isolated_23-2151853616.jpg', count: 0, active: true },
        { word: 'golf', img: 'https://img.freepik.com/free-vector/isolated-professional-golfer-cartoon-character_1308-133510.jpg', count: 0, active: true },
        { word: 'bowling', img: 'https://img.freepik.com/premium-photo/back-view-child-throwing-bowling-ball_29360-93.jpg', count: 0, active: true },
        { word: 'swimming', img: 'https://img.freepik.com/premium-vector/kids-water-pool-children-sport-education-swimming-lesson-cartoon-clipart_80590-9453.jpg', count: 0, active: true },
        { word: 'soccer', img: 'https://img.freepik.com/premium-vector/kids-moments-vector-illustration-concept_1253202-72219.jpg', count: 0, active: true },
        { word: 'badminton', img: 'https://img.freepik.com/premium-photo/boy-with-badminton-rackets-outdoors_926199-3902824.jpg', count: 0, active: true },
        { word: 'running', img: 'https://img.freepik.com/premium-vector/funny-little-children-running-outside_29937-4004.jpg', count: 0, active: true },
        { word: 'skipping', img: 'https://img.freepik.com/premium-vector/children-happy-play-joyful-likely-illustration_1278055-1688.jpg', count: 0, active: true },
        { word: 'basketball', img: 'https://img.freepik.com/premium-vector/vector-illustration-kid-playing-basketball_679557-3149.jpg', count: 0, active: true },
        { word: 'hockey', img: 'https://www.activesgcircle.gov.sg/hs-fs/hubfs/Circle%202.0%20Refresh/images/IMG_1032_11zon.webp?width=300', count: 0, active: true },
        { word: 'table tennis', img: 'https://img.freepik.com/premium-photo/young-girl-loves-table-tennis-young-girl-playing-table-tennis-indoors_629685-92163.jpg', count: 0, active: true }
    ];

    let quotes = [
        "Mistakes are proof that you are trying! üåü",
        "Every small step leads to a giant leap! üöÄ",
        "Learning is a superpower! ü¶∏‚Äç‚ôÇÔ∏èü¶∏‚Äç‚ôÄÔ∏è",
        "Practice makes progress! ‚úèÔ∏è",
        "You are a spelling superstar! ‚≠ê"
    ];

    let wordList = JSON.parse(localStorage.getItem('ss_wordlist')) || [...defaultWords];
    let userName = localStorage.getItem('ss_username') || "Student";
    let totalStars = parseInt(localStorage.getItem('engTotalStars')) || 0;
    let spellDifficulty = parseInt(localStorage.getItem('ss_difficulty')) || 50;
    let isRandom = localStorage.getItem('ss_random') === 'true';
    let chTimeLimit = parseInt(localStorage.getItem('ss_ch_timer')) || 30;
    let chHighScore = parseInt(localStorage.getItem('ss_ch_high')) || 0;
    
    let chInterval, chScore, chTimeLeft, chTaskType = "match";
    let chCorrectCount = 0, chWrongCount = 0, chPracticeWords = new Set();
    let learnIdx=0, matchIdx=0, spellIdx=0, spellInput="", holdTimer;

    function checkAdminAccess() {
        const pass = prompt("Please enter Parent Password:");
        if (pass === DEFAULT_ADMIN_PASS) showScreen('admin');
        else if (pass !== null) alert("Incorrect password!");
    }

    function getActive() { 
        let active = wordList.filter(w => w.active);
        if (isRandom) return [...active].sort(() => 0.5 - Math.random());
        return active;
    }

    function showScreen(id) {
        window.speechSynthesis.cancel();
        clearInterval(chInterval);
        document.getElementById('ch-results').style.display = 'none';
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active-screen'));
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        document.getElementById(id).classList.add('active-screen');
        const navId = id === 'library' ? 'nav-lib' : 'nav-' + id;
        if(document.getElementById(navId)) document.getElementById(navId).classList.add('active');
        
        if(id === 'home') {
            document.getElementById('home-greeting').innerText = `Hi ${userName}! üëã`;
            document.getElementById('motivational-quote').innerText = quotes[Math.floor(Math.random() * quotes.length)];
        }
        if(id === 'admin') renderAdmin();
        if(id === 'library') renderLibrary();
        if(id === 'learn') renderLearn();
        if(id === 'spell') renderSpell();
        if(id === 'match') renderMatch();
        if(id === 'challenge') startChallenge();
        document.getElementById('stars-total').innerText = `üåü ${totalStars} Mastery Stars`;
    }

    function readQuoteOutLoud() { speak(document.getElementById('motivational-quote').innerText); }

    function renderAdmin() {
        const listContainer = document.getElementById('admin-word-list');
        listContainer.innerHTML = wordList.map((w, i) => `
            <tr style="border-bottom: 1px solid #eee;">
                <td style="padding: 10px 0;"><label class="switch"><input type="checkbox" ${w.active?'checked':''} onchange="toggleWordActive(${i})"><span class="slider"></span></label></td>
                <td style="font-weight:bold; font-family:'Comic Neue'; font-size: 16px;">${w.word}</td>
                <td style="text-align:right;">
                    <button class="admin-controls-btn" onclick="moveWord(${i}, -1)">‚ñ≤</button>
                    <button class="admin-controls-btn" onclick="moveWord(${i}, 1)">‚ñº</button>
                    <button class="admin-controls-btn" onclick="editWordImg(${i})">üîó</button>
                    <button class="admin-controls-btn" onclick="deleteWord(${i})" style="color:red;">‚úï</button>
                </td>
            </tr>
        `).join('');
        document.getElementById('name-input').value = userName;
        document.getElementById('random-toggle').checked = isRandom;
        document.getElementById('diff-slider').value = spellDifficulty;
        document.getElementById('diff-desc').innerText = `Difficulty: ${spellDifficulty}% Hidden`;
        document.getElementById('ch-timer-slider').value = chTimeLimit;
        document.getElementById('ch-timer-val').innerText = `${chTimeLimit}s`;
    }

    function moveWord(index, dir) {
        const newIdx = index + dir;
        if (newIdx < 0 || newIdx >= wordList.length) return;
        [wordList[index], wordList[newIdx]] = [wordList[newIdx], wordList[index]];
        save(); renderAdmin();
    }

    function editWordImg(index) {
        const newUrl = prompt("New image URL for '" + wordList[index].word + "':", wordList[index].img);
        if (newUrl) { wordList[index].img = newUrl; save(); renderAdmin(); }
    }

    function toggleWordActive(i) { wordList[i].active = !wordList[i].active; save(); }
    function deleteWord(i) { if(confirm("Delete?")) { wordList.splice(i, 1); save(); renderAdmin(); } }
    function updateName() { userName = document.getElementById('name-input').value; localStorage.setItem('ss_username', userName); alert("Saved!"); }
    function toggleRandom(val) { isRandom = val; localStorage.setItem('ss_random', val); }
    function updateDiff(val) { spellDifficulty = parseInt(val); document.getElementById('diff-desc').innerText = `Difficulty: ${val}% Hidden`; localStorage.setItem('ss_difficulty', val); }
    function updateChTimer(val) { chTimeLimit = parseInt(val); document.getElementById('ch-timer-val').innerText = `${val}s`; localStorage.setItem('ss_ch_timer', val); }
    function addNewWord() {
        const t = document.getElementById('new-word-text').value.trim().toLowerCase();
        const i = document.getElementById('new-word-img').value.trim();
        if(t && i) { wordList.push({word:t, img:i, count:0, active:true}); save(); renderAdmin(); document.getElementById('new-word-text').value=''; document.getElementById('new-word-img').value=''; }
    }
    function resetProgress() { if(confirm("Wipe all data?")) { localStorage.clear(); location.reload(); } }

    function renderLearn() { 
        const a = getActive(); if(!a.length) return;
        const item = a[learnIdx % a.length];
        document.getElementById('learn-img').src = item.img; 
        document.getElementById('learn-word').innerText = item.word;
    }
    function handleLearnClick() { const a = getActive(); if(a[learnIdx % a.length]) spellSequence(a[learnIdx % a.length].word); }

    function renderSpell() {
        const a = getActive(); if(!a.length) return; 
        const item = a[spellIdx % a.length];
        document.getElementById('spell-img').src = item.img; spellInput = "";
        const container = document.getElementById('spell-container'); container.innerHTML = '';
        const raw = item.word.replace(/\s/g, '');
        const hiddenCount = Math.ceil(raw.length * (spellDifficulty / 100));
        const hideIndices = []; 
        while(hideIndices.length < hiddenCount) { let r = Math.floor(Math.random() * raw.length); if(!hideIndices.includes(r)) hideIndices.push(r); }
        raw.split('').forEach((char, i) => { 
            const s = document.createElement('div'); s.className = 'slot'; 
            if(!hideIndices.includes(i)) { s.innerText = char; s.classList.add('prefilled'); }
            container.appendChild(s); 
        });
        const pool = document.getElementById('letter-pool'); pool.innerHTML = '';
        raw.split('').sort(() => 0.5 - Math.random()).forEach(l => {
            const b = document.createElement('button'); b.className = 'letter-btn'; b.innerText = l;
            b.onclick = () => {
                const slots = document.querySelectorAll('#spell-container .slot:not(.prefilled)');
                if(spellInput.length < slots.length) {
                    slots[spellInput.length].innerText = l; spellInput += l; speak(l);
                    let res = ""; document.querySelectorAll('#spell-container .slot').forEach(s => res += s.innerText);
                    if(res === raw) { earnSuccess(item.word); setTimeout(() => { spellIdx++; renderSpell(); }, 1800); }
                    else if (res.length === raw.length) { speak("Try again"); setTimeout(() => { spellInput = ""; slots.forEach(s => s.innerText = ""); }, 600); }
                }
            };
            pool.appendChild(b);
        });
    }

    function renderMatch() {
        const a = getActive(); if(!a.length) return; 
        const correct = a[matchIdx % a.length];
        document.getElementById('match-img').src = correct.img;
        const container = document.getElementById('match-options'); container.innerHTML = '';
        let opts = [...a].sort(() => 0.5 - Math.random()).slice(0, 3);
        if(!opts.find(o => o.word === correct.word)) opts[0] = correct;
        opts.sort(() => 0.5 - Math.random()).forEach(opt => {
            const b = document.createElement('button'); b.className = 'match-btn'; b.innerText = opt.word;
            b.onclick = () => { if(opt.word === correct.word) { earnSuccess(opt.word); setTimeout(() => { matchIdx++; renderMatch(); }, 1800); } else speak("Try again"); };
            container.appendChild(b);
        });
    }

    function startChallenge() {
        const active = getActive();
        if(!active.length) { alert("Enable words in Parent Tools!"); showScreen('home'); return; }
        chScore = 0; chCorrectCount = 0; chWrongCount = 0; chPracticeWords.clear();
        chTimeLeft = chTimeLimit; chTaskType = "match";
        document.getElementById('ch-high').innerText = chHighScore;
        document.getElementById('ch-score').innerText = 0;
        runChTimer(); nextChTask();
    }

    function runChTimer() {
        const updateDisp = () => {
            const m = Math.floor(chTimeLeft / 60); const s = chTimeLeft % 60;
            document.getElementById('ch-timer').innerText = `${m}:${s < 10 ? '0' : ''}${s}`;
        };
        updateDisp();
        chInterval = setInterval(() => {
            chTimeLeft--; updateDisp();
            if(chTimeLeft <= 0) endChallenge();
        }, 1000);
    }

    function nextChTask() {
        const active = getActive();
        const item = active[Math.floor(Math.random() * active.length)];
        const targetWord = item.word.replace(/\s/g, '');
        document.getElementById('ch-img').src = item.img;
        const container = document.getElementById('ch-content'); container.innerHTML = '';
        
        if(chTaskType === "match") {
            document.getElementById('ch-instruction').innerText = "Match it!";
            let opts = [...active].sort(() => 0.5 - Math.random()).slice(0, 3);
            if(!opts.find(o => o.word === item.word)) opts[0] = item;
            opts.sort(() => 0.5 - Math.random()).forEach(opt => {
                const b = document.createElement('button'); b.className = 'match-btn'; b.innerText = opt.word;
                b.onclick = () => { 
                    if(opt.word === item.word) { chScore += 10; chCorrectCount++; chTaskType = "spell"; nextChTask(); } 
                    else { speak("Try again"); chWrongCount++; chPracticeWords.add(item.word); } 
                    document.getElementById('ch-score').innerText = chScore; 
                };
                container.appendChild(b);
            });
        } else {
            document.getElementById('ch-instruction').innerText = "Spell it!";
            spellInput = "";
            const row = document.createElement('div'); row.className = 'spell-row';
            targetWord.split('').forEach(() => { const s = document.createElement('div'); s.className = 'slot'; row.appendChild(s); });
            container.appendChild(row);

            const pool = document.createElement('div'); pool.style.display="flex"; pool.style.flexWrap="wrap"; pool.style.gap="8px"; pool.style.justifyContent="center";
            targetWord.split('').sort(() => 0.5 - Math.random()).forEach(l => {
                const b = document.createElement('button'); b.className = 'letter-btn'; b.innerText = l;
                b.onclick = () => {
                    const slots = container.querySelectorAll('.slot');
                    if(spellInput.length < slots.length) {
                        slots[spellInput.length].innerText = l; spellInput += l; speak(l);
                        if(spellInput === targetWord) { chScore += 20; chCorrectCount++; chTaskType = "match"; setTimeout(nextChTask, 600); } 
                        else if (spellInput.length === targetWord.length) {
                            speak("Try again"); chWrongCount++; chPracticeWords.add(item.word);
                            setTimeout(() => { spellInput = ""; slots.forEach(s => s.innerText = ""); }, 600);
                        }
                    }
                    document.getElementById('ch-score').innerText = chScore;
                };
                pool.appendChild(b);
            });
            container.appendChild(pool);

            const controls = document.createElement('div'); controls.style.width = "100%"; controls.style.marginTop = "20px";
            const delBtn = document.createElement('button');
            delBtn.className = "action-btn"; delBtn.style.background = "var(--delete)"; delBtn.style.width = "100%"; delBtn.style.height = "50px";
            delBtn.innerText = "‚å´ BACKSPACE";
            delBtn.onclick = () => {
                const slots = container.querySelectorAll('.slot');
                if (spellInput.length > 0) {
                    spellInput = spellInput.slice(0, -1);
                    slots[spellInput.length].innerText = "";
                }
            };
            controls.appendChild(delBtn);
            container.appendChild(controls);
        }
    }

    function endChallenge() {
        clearInterval(chInterval);
        confetti({ particleCount: 150 });
        if(chScore > chHighScore) { chHighScore = chScore; localStorage.setItem('ss_ch_high', chHighScore); }
        document.getElementById('res-score').innerText = chScore;
        document.getElementById('res-correct').innerText = chCorrectCount;
        document.getElementById('res-wrong').innerText = chWrongCount;
        const listDiv = document.getElementById('res-practice-list');
        listDiv.innerHTML = chPracticeWords.size > 0 
            ? Array.from(chPracticeWords).map(w => `<span class="practice-tag">${w}</span>`).join('')
            : '<p style="color:#888;">No mistakes! Perfect run! üåü</p>';
        document.getElementById('ch-results').style.display = 'flex';
    }

    function closeResults() { showScreen('home'); }
    function nextItem(m) { if(m==='learn') { learnIdx++; renderLearn(); } }
    function prevItem(m) { if(m==='learn') { learnIdx--; renderLearn(); } if(m==='spell') { spellIdx--; renderSpell(); } if(m==='match') { matchIdx--; renderMatch(); } }
    function handleBackspace() { const slots = document.querySelectorAll('#spell-container .slot:not(.prefilled)'); if (spellInput.length > 0) { spellInput = spellInput.slice(0, -1); slots[spellInput.length].innerText = ""; } }
    function speak(t) { window.speechSynthesis.cancel(); const u = new SpeechSynthesisUtterance(t); u.lang = 'en-US'; window.speechSynthesis.speak(u); }
    async function spellSequence(word) {
        window.speechSynthesis.cancel(); speak(word);
        await new Promise(r => setTimeout(r, 1200));
        for(let char of word) { if(char !== ' ') { speak(char); await new Promise(r => setTimeout(r, 450)); } }
        await new Promise(r => setTimeout(r, 400)); speak(word);
    }
    function earnSuccess(word) {
        const item = wordList.find(w => w.word === word);
        if(item) { item.count++; totalStars++; localStorage.setItem('engTotalStars', totalStars); save(); confetti(); speak(word); document.getElementById('stars-total').innerText = `üåü ${totalStars} Mastery Stars`; }
    }
    function save() { localStorage.setItem('ss_wordlist', JSON.stringify(wordList)); }
    function renderLibrary() {
        const grid = document.getElementById('library-grid'); grid.innerHTML = '';
        wordList.filter(w => w.active).forEach(w => {
            const card = document.createElement('div'); card.className = 'lib-card';
            card.innerHTML = `<div class="lib-word">${w.word}<div style="font-size:12px;color:#f1c40f">üåü ${w.count}</div></div><img src="${w.img}" style="width:60px;height:60px;object-fit:contain;">`;
            card.onmousedown = card.ontouchstart = () => holdTimer = setTimeout(() => showPopup(w), 600);
            card.onmouseup = card.onmouseleave = card.ontouchend = () => clearTimeout(holdTimer);
            card.onclick = () => speak(w.word);
            grid.appendChild(card);
        });
    }
    function showPopup(item) { document.getElementById('popup-img').src = item.img; document.getElementById('popup-text').innerText = item.word; document.getElementById('lib-popup').style.display = 'flex'; spellSequence(item.word); }
    function closePopup() { document.getElementById('lib-popup').style.display = 'none'; window.speechSynthesis.cancel(); }
    function quitChallenge() { if(confirm("Quit Challenge?")) showScreen('home'); }
    function toggleFullscreen() { if (!document.fullscreenElement) document.documentElement.requestFullscreen(); else document.exitFullscreen(); }

    showScreen('home');
</script>
</body>
</html>
